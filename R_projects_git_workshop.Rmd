---
title: "Version controlled R projects - using Git from Rstudio"
author: "Sonia Mazzi - Data Science Campus - ONS"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    fig_caption: yes
    fig_height: 6
    fig_width: 11
    keep_md: yes
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    toc_float: yes
---

<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"pics/dsclogo.png\" style=\"float: right;width: 150px;\"/>')
   });
</script>

```{r echo=FALSE}
library(knitr)
```
<br>
<br>

<center>
![](pics/git.png){width=40%}  ![](pics/github.png)

![](pics/Rstudio.png){width=60%}
</center>

# Introduction

Project file organisation is essential for reproducibility. For example, imagine what would happen if you are writing and running an R script and you store the script in a folder but ouput files of the code go to a different folder.

Rule number one for project file management: when you work on a data analysis project, always keep all the project files organised in one folder.

An R project is a feature of RStudio which helps you to manage and to organise data science projects and to interact with the project files, both individually and as a member of a team.

In order to build an R project you start with a normal/usual folder (it could be empty if the project just started), which will be your project folder, the folder where all the files associated with the project will be stored. You can create an R project also out of an existing folder. Just use the drop-down menu File > New Project and then make the appropriate choice.

Once you created an R project in a folder named, say, folder_name, you should be able to see a new file in that folder called folder_name.Rproj. Clicking on that file will open a new session in RStudio with a working directory folder_name. So, no need to set the working directory manually. All the files generated will go to the working directory.


<div class="alert alert-info">
RStudio projects give you a solid workflow that will serve you well when managing data analysis projects:

* Create an RStudio project for each data analysis project.

* Keep data files there; we’ll talk about loading them into R in data import.

* Keep scripts there; edit them, run them in bits or as a whole.

* Save your outputs (plots and cleaned data) there.

* Only ever use relative paths, not absolute paths.

Everything you need is in one place, and cleanly separated from all the other projects that you are working on.
</div>


RStudio has the ability to use version control for R projects using a very easy to use graphical interface.

In this workshop we will focus on Git/GitHub-version-controlled R projects.


The pre-requisites for this workshop are that you have taken the "Version  control with Git and GitHub" workshop and that you are familiar with R and RStudio, preferably by having taken "Data Science with R".


# Creating repos and pull and push using Git on the command line and GitHub - refresher

1. Create a repo on GitHub: Go to https://github.com and log in to your GitHub account.

2. On the "Repositories" field on the left click the green button "New". Or, if you are on your own profile page, click on “Repositories”, then click the green “New” button.

3. Please, specify

    + Repository name: test_repo

    + Description: “testing connectivity”

    + Public.

    + YES Initialize this repository with a README.

    + For everything else, just accept the default.

4. Click the green button “Create repository”.

5. Copy the HTTPS clone URL to your clipboard via the green “Clone or Download” button.

6. Clone the GitHub repo to your computer.

 + Open the shell (Terminal in a Mac)

 + Using `pwd` note the working directory. The command to change directory is `cd`. The command to list the files in a directory is `ls`. 

 + Clone test_repo from GitHub to your computer. In the command below you should be able to paste the URL that you copied above. 

`
git clone https://github.com/YOUR_USERNAME/test_repo.git
`

There will be output messages.

7. Change working directory to test_repo

`
cd test_repo
`

and list the files in test_repo


`
ls
`



8. Add a line to README.md and verify that Git notices the change:


`
echo "A line I wrote on my local computer" >> README.md
`


`
git status
`


The output should look something like this:

```
On branch master
Your branch is up to date with 'origin/master'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   README.md

no changes added to commit (use "git add" and/or "git commit -a")
```


9. Stage (“add”) and commit this change and push to your remote repo on GitHub. 

`
git add -A
`

`
git commit -m "A commit from my local computer"
`

`
git push
`


You will see some output messages.

<div class="alert alert-info">
The commit message is mandatory for every commit, so if you forget the -m flag, Git will prompt you for a commit message anyway. And you might not like the editor that Git chooses. It is good practice to write meaningful commit messages, so that, in the future, potential collaborators (and your future self) will understand the progression of a project.


If you forget to type the commit message, Git will take to an editor. Type your message. When you are done
press Esc and then : (colon). The cursor will go to the bottom of the screen at the colon prompt. Save your changes and exit the editor by typing `wq` after the colon.
</div>

10. Confirm the local changes propagated to the GitHub remote

Refresh the web browser. 

You should see the new “A line I wrote on my local computer” in the README.

If you click on “commits,” you should see one with the message “A commit from my local computer.”




<br>

<br>


# Creating a version controlled R project


We continue to work with the same repo, test_repo, we created before.

1. In GitHub, copy the HTTPS clone URL to your clipboard via the green “Clone or Download” button.

2. Clone the GitHub repository, test_repo, to your computer via RStudio as follows:

    + In RStudio, start a new Project:

    File > New Project > Version Control > Git. In “Repository URL”, paste the URL of the test_repo GitHub repository. It will be something like this https://github.com/yourusername/test_repo.git.

    + Accept the default project directory name, e.g. test_repo, which coincides with the GitHub repo name.

    + Notice where the Project will be saved locally. 
    
    + Click “Create Project”.

3. You should find yourself in a new local RStudio Project that represents the new test repo we just created on GitHub. This should download the README.md file from GitHub. Look in RStudio’s file browser pane for the README.md file.

4. Make local changes and save (locally)

 From RStudio, modify the README.md file, e.g., by adding the line “This is a line from RStudio”. Save your changes.

5. Commit these changes to your local repo. From RStudio:

    + Click the “Git” tab in the upper right pane.
    
    + Check “Staged” box for README.md.
    
    + If you are not already in the Git pop-up, click “Commit”.
    
    + Type a message in “Commit message”, such as “Commit from RStudio”.
    
    + Click “Commit”.

6. Push your local changes online to GitHub.

Click the green “Push” button  with an up-arrow to send your local changes to GitHub. 

7. Confirm the local changes propagated to the GitHub remote.

  + Go back to the browser.

  + Refresh. You should see the new “This is a line from RStudio” in the README. If you click on “commits”, you should see one with the message “Commit from RStudio”.

<br>

<div class="alert alert-info">

Now, a few important points

* **Make local changes, save, commit**

Do this every time you finish a valuable chunk of work, probably many times a day.

* **Push your local changes to GitHub**

Do this a few times a day, but possibly less often than you commit.

* **Before you push your local changes into GitHub, pull from GitHub**

In general (and especially when collaborating with other project team members) you will usually need to pull changes from the remote (GitHub) before pushing the local changes you have made. The reason is that before you push your changes you want to get the changes that someone in your team has made and pushed before you. For this reason, it’s a good idea to try and get into the habit of pulling before you attempt to push.


To pull from RStudio, click the blue “Pull” button in the “Git” tab in RStudio. If you get the message “Already up-to-date” then there were no changes pushed before. 
</div>


# Git/GitHub workflows from RStudio

## New project

To create a new project and use Git/GitHub as vcs from RStudio do exactly what we did in the previous section.


## Existing project


1. All your project files must be stored in a directory/folder on your computer. Note where the project folder is.

2. Make a repo on GitHub as usual (see above).

Name the repo so that the name reflects what the project is about. But be concise.

3. Create a  new RStudio Project via git clone as usual (see above). When you click “Create Project” to create a new directory, it will be all of these things:

    + a directory or “folder” on your computer;

    + a Git repository, linked to a remote GitHub repository;

    + an RStudio Project.

This should download the README.md file that we created in GitHub in the previous step. Look in RStudio’s file browser pane for the README.md file.

4. Bring your existing project over:

    + Using your favorite method of moving or copying files, copy the files that constitute your existing project into the directory for this new project.

    + In RStudio, consult the Git pane and the file browser.

    + Are you seeing all the files? They should be here if your move/copy was successful. Are they showing up in the Git pane with questions marks? They should be appearing as new untracked files.

5. Stage and commit: Commit your files to this repo.

    + Click the “Git” tab in upper right pane

    + Check “Staged” box for all files you want to commit.
Recall: this will all go to GitHub. So do consider if that is appropriate for each file. You can keep a file locally without committing it to the Git repo and sending to GitHub. Just let it sit there in your Git pane, without being staged. If this is a long-term situation, list the file in .gitignore.

    + If you’re not already in the Git pop-up, click “Commit”

    + Type a message in “Commit message”, such as “init”.

    + Click “Commit”

6. Push your local changes to GitHub (pull first).

    + Click the green “Push” button to send your local changes to GitHub. 

    + Go back to the browser. 

    + Refresh. You should see all the project files you committed there.

    + If you click on “commits,” you should see one with the message “init”.

## Branching

We will continue to work with test_repo to practice branching from RStudio.

1. In the Git tab, on the upper right area of RStudio, click on the icon ![](pics/branch_icon.png) and a pop-up window should open. Enter the name of the new branch. Call it "virtual_team_mate".

```
>>> /usr/local/git/bin/git checkout -B virtual_team_mate
Switched to a new branch 'virtual_team_mate'
M	README.md
>>> /usr/local/git/bin/git push -u origin virtual_team_mate
remote: 
remote: Create a pull request for 'virtual_team_mate' on GitHub by visiting:        
remote:      https://github.com/YOUR_USERNAME/test_repo/pull/new/virtual_team_mate        
remote: 
To https://github.com/YOUR_USERNAME/test_repo.git
 * [new branch]      virtual_team_mate -> virtual_team_mate
Branch 'virtual_team_mate' set up to track remote branch 'virtual_team_mate' from 'origin'.
```
2. Check that, on the right upper pane, within the Git tab, next to the branch icon it should say "virtual_team_mate". That means you are now in the "virtual_team_mate_branch". Any changes you push to GitHub will be pushed to this branch.

3. Add the line "Line added working on branch" to README.md . **Save** your changes by clicking on the diskette icon. In the upper right pane, Git tab, you should see that a blue icon with the letter M shows in "Status" next to README.md. That means the file has been modified. Click on the "Staged" box to **add** the file, click on **Commit**, write the commit message "added a line to README", 

4. Click on "New pull request" to issue a pull-request. Write the comment "requesting feedback on my edits" and click the green button "Create pull request". You should arrive into a page with a full description of the branch. We can read that there are no conflict with the master branch (as one file is simply a subset of the other). Now, other team members can post issues, comments.

5. Post an issue. Go all the way up to the top of the page and click on issues and click on the green button New issue. Write a title for the issue (a subject, something that summarises your comment), e.g. "last line", and a text (e.g. "I think the last line can be deleted").

6. Deal with the issue. You can add an icon to the issue (such as thumbs up, to denote agreement) or reply in the commentary box. When satisfied with the discussion click on the box "Close issue".

7. Post a new issue, make comments on it (pretending to be a team member), reply and close the issue.

8. Once you are happy that enough discussion has taken place, go to the very top of the page and click on pull requests. (Usually one team member is nominated to deal with pull-requests. Pretend to be that team member). Click on "Virtual team mate" (name of the branch), you should land in the page that has the descriptions of the branch, and click the green button "Merge Pull Request". Click on the green button "Confirm merge". You should now read the message "Pull request successfully merged and closed -
You’re all set—the virtual_team_mate branch can be safely deleted.". Click on the "Delete branch" button. the branch has been deleted now as it is not needed any longer.

9. Go back to the main page of the repo (at the very top of the page click on the repo's name) and verify there is just one branch (master) and everything looks as expected (README.md should now have the edits that were pushed into the branch).

# Create a web page for your project GitHub site

We will author an R Markdown document and render it to HTML. We discuss how to keep the intermediate Markdown file, the figures, and what to commit to Git and push to GitHub. If GitHub is the primary venue, we render directly to GitHub-flavored markdown and never create HTML.

## Start creating the web page

1. We keep on working with test_repo which is an R project and a Git repo which is connected to a GitHub repo.

    - In RStudio do this: File > New File > R Markdown …

    - Give an informative title (this is the title of the document, not a file name). This will appear in the document but does not necessarily have anything to do with the file’s name. But the title and filename should be related. 

    - Edit the  Author field.

    - Accept the default output format of HTML.

    - Click OK.

    - Save this document with filename my_github_webpage. The actual name of the file is my_github_webpage.Rmd. 

    - Stage and commit here so you can see what is about to change.

2. Click on “Knit”. RStudio should display a preview of the resulting HTML. Also look at the file browser in the lower right pane. You should see the R Markdown document my_github_webpage.Rmd and the resulting HTML my_github_page.html. Stage and commit.

3. Push the current state of the repo to GitHub. Go visit it in the browser.
Do you see the new files?  Verify this:

    - my_github_webpage.Rmd is readable.
  
    - my_github_webpage.html doesn't display as it did in RStudio or as it would display in a web browser. It's quite unreadable.
  

## R markdown output format


In order to produce the html output from the R markdown file .Rmd, R first generates an intermediate markdown file with the extension .md.
The process that turns your R Markdown to HTML is: my_github_webpage.Rmd --> my_github_webpage.md --> my_github_webpage.html. 
By default RStudio discards the .md file, but there are cases when you may want to keep the .md markdown file.

One of these cases is when you display files on GitHub.
GitHub renders .md files in an almost HTML-like way and so these files can be considered GitHub webpages. 
In contrast, HTML is rendered as plain text on GitHub.

There are ways in which we can control the output in RStudio.

- **If you only want to keep the .md markdown output file** (so, you don't want the .html file) you can edit the YAML header  – the text at the top of the file between leading and trailing lines of ---. 

In many cases, you only want the markdown. In that case, we switch the output format to github_document. This means render will be foo.Rmd --> foo.md, where foo.md is GitHub-flavored markdown. If you still want the HTML but also the intermediate markdown, there’s a way to request that too.

Output format is one of the many things we can control in the YAML front-matter – the text at the top of your file between leading and trailing lines of ---. In output, instead of "html_document", type "github_document". The YAML should now look something like:

```
---
title: "A GitHub web page"
author: "Me"
date: "2019-07-23"
output: github_document
---
```

- **If you wish to keep both the .md and the .html outputs**, you can specify this using RStudio: click on the “gear” in the top bar of the source editor, near the “Knit HTML” button. Select “Output options” and go to the Advanced tab and check “Keep markdown source file.” Your YAML should now looks something like this:

```
---
title: "A GitHub web page"
author: "Me"
date: "2019-07-23"
output:
  html_document:
    keep_md: true
---
```

You should have gained the line keep_md: true. You can also simply edit the file yourself to achieve this. Please, note that the indentations are crucial and not just decorative.

## Continue editing the web page

4. Continuing with the exercise, make a choice whether you want to keep just the .md file or both the .md and the .html. Render by clicking on the “Knit” button. Save, add and commit.


5. Now revisit the file browser. 
    
    - In addition to my_github_webpage.Rmd, you should now see my_github_webpage.md. 
    
    - If there are R chunks that make figures, the usage of markdown output formats will also cause those figure files to be stored in a sub-directory named my_github_webpage_files.
    
    - If you commit and push my_github_webpage.md and everything inside my_github_webpage_files, then anyone with permission to view your GitHub repo can see a readable version of your report.

    - If your output format is html_document, you should still see my_github_webpage.html. If your output format is github_document and you see my_github_webpage.html, that could be a leftover from earlier experiments. You can delete that file.

    
6. Commit and push to GitHub. 

    - Go visit it in the browser. Do you see the modifications and new files? Your .Rmd should be modified (the YAML frontmatter changed). And you should have gained at least, the associated markdown file.

    - Visit the markdown file and compare to our previous HTML. Do you see how the markdown is much more useful on GitHub?

7. Now go back to my_github_webpage.Rmd in RStudio and keep on editing it. You can add text, you can separate your work into sections and subsections, R chunks, external images, web links, you name it.
    
    - To add text just type it.


    - To divide the report into sections, subsections, etc, type `# ` (hash - space) before a section name. Type `## ` before a subsection name, `### ` before a sub-subsection name, etc. It is bad style to overdo sub-...-subsectioning. Don't forget the space after the last hash.
  
    - To add R chunks use the insert menu or just start the chunk with ` ```{r} `, type your R code starting on a new line, finish the chunk with ` ``` ` which should be typed on a separate line (not next to code).

    - To add an external image in a file, say pic.png, add the line
  ```
  ![](pic.png)
  ```
  You can add a caption between the square brackets if you wish.
  
    - A weblink is entered as 
  ```
  [R markdown official documentation](http://rmarkdown.rstudio.com)
  ```
  Giving the output
  
  [R markdown official documentation](http://rmarkdown.rstudio.com)
  
 Give it a try and edit your webpage, knit (knitting automatically saves the document), add, commit and push and view it in GitHub.
 
 

# Clean up

When you have finished working, please clean up the teaching laptop.


Local: When you’re ready to clean up, you can delete the local repo any way you like. It’s just a regular directory on your computer.

Here’s how to do that in the shell, if current working directory is test_repo:

```
cd ..
rm -rf myrepo/
```

GitHub: In the browser, go to your repo’s landing page on GitHub. Click on “Settings”.

Scroll down, click on “delete repository,” and do as it asks.
